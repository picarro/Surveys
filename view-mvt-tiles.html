<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MVT Tiles Viewer</title>
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <link
    href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <style>
    body { 
      margin: 0; 
      font-family: Arial, sans-serif;
    }
    #map { 
      width: 100vw; 
      height: 100vh; 
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 300px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .controls input, .controls select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .controls input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 12px;
    }
    .layer-options {
      margin-top: 5px;
    }
    .layer-option {
      display: flex;
      align-items: center;
      margin: 5px 0;
      padding: 5px;
      background: #f9f9f9;
      border-radius: 3px;
    }
    .layer-option label {
      margin: 0;
      font-weight: normal;
      font-size: 13px;
      cursor: pointer;
      flex: 1;
    }
    .controls button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #007cbf;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }
    .controls button:hover {
      background: #005a8f;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 3px;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
    }
    .status-item {
      margin: 3px 0;
      padding: 3px;
    }
    .status-item.error {
      color: #d32f2f;
    }
    .status-item.success {
      color: #388e3c;
    }
    .status-item.info {
      color: #1976d2;
    }
  </style>
</head>
<body>
<div class="controls">
  <label>Survey Session ID:</label>
  <input type="text" id="surveySessionId" value="6321d911-496c-4312-9910-fe3929ad255d" placeholder="Enter survey session ID">
  
  <label>Layers (Select multiple):</label>
  <div class="layer-options">
    <div class="layer-option">
      <input type="checkbox" id="layer-fov" value="fov" checked>
      <label for="layer-fov">FOV</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="layer-breadcrumb" value="breadcrumb" checked>
      <label for="layer-breadcrumb">Breadcrumb</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="layer-lisa" value="lisa" checked>
      <label for="layer-lisa">LISA</label>
    </div>
  </div>
  
  <label>Base URL:</label>
  <input type="text" id="baseUrl" value="http://localhost:3000/api/mvt" placeholder="Base URL for MVT endpoint">
  
  <button onclick="updateMap()">Update Map</button>
  
  <div class="status" id="status">
    <div class="status-item info">Ready to load map...</div>
  </div>
</div>

<div id="map"></div>

<script>
let map;
const availableLayers = ['fov', 'breadcrumb', 'lisa'];

function addStatus(message, type = 'info') {
  const statusDiv = document.getElementById('status');
  const item = document.createElement('div');
  item.className = `status-item ${type}`;
  item.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
  statusDiv.insertBefore(item, statusDiv.firstChild);
  
  // Keep only last 20 messages
  while (statusDiv.children.length > 20) {
    statusDiv.removeChild(statusDiv.lastChild);
  }
}

function getSelectedLayers() {
  return availableLayers.filter(layer => {
    const checkbox = document.getElementById(`layer-${layer}`);
    return checkbox && checkbox.checked;
  });
}

function initializeMap() {
  const surveySessionId = document.getElementById('surveySessionId').value;
  const baseUrl = document.getElementById('baseUrl').value;
  const selectedLayers = getSelectedLayers();
  
  if (!surveySessionId || surveySessionId.trim() === '') {
    addStatus('Error: Survey Session ID is required', 'error');
    return;
  }
  
  if (selectedLayers.length === 0) {
    addStatus('Error: Please select at least one layer', 'error');
    return;
  }
  
  addStatus(`Initializing map with layers: ${selectedLayers.join(', ')}`, 'info');
  
  // Build sources and layers
  const sources = {
    "osm": {
      type: "raster",
      tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
      tileSize: 256,
      attribution: "Â© OpenStreetMap contributors"
    }
  };
  
  const layers = [
    {
      id: "osm-layer",
      type: "raster",
      source: "osm",
      minzoom: 0,
      maxzoom: 22
    }
  ];
  
  // Add sources and layers for each selected layer type
  selectedLayers.forEach(layerType => {
    const tileUrl = `${baseUrl}/${layerType}/{z}/{x}/{y}?surveySessionId=${surveySessionId}`;
    sources[layerType] = {
      type: "vector",
      tiles: [tileUrl],
      minzoom: 14,
      maxzoom: 18
    };
    
    layers.push({
      id: `${layerType}-layer`,
      type: "fill",
      source: layerType,
      "source-layer": `${layerType}_layer`,
      paint: {
        "fill-color": getLayerColor(layerType),
        "fill-opacity": 0.5,
        "fill-outline-color": "#000000"
      },
      minzoom: 14,
      maxzoom: 18
    });
  });
  
  // Add OpenStreetMap as base layer
  map = new maplibregl.Map({
    container: "map",
    style: {
      version: 8,
      sources: sources,
      layers: layers
    },
    center: [ 88.40767190890205, 22.582022906093922],
    zoom: 14
  });

  map.on('error', (e) => {
    console.error('Map error:', e);
    addStatus(`Map error: ${e.error ? e.error.message : JSON.stringify(e)}`, 'error');
  });

  map.on('load', () => {
    addStatus('Map loaded successfully', 'success');
    console.log('Map loaded successfully');
    
    // Check if sources have data
    selectedLayers.forEach(layerType => {
      const source = map.getSource(layerType);
      if (source) {
        addStatus(`Source "${layerType}" loaded`, 'success');
      }
    });
  });

  map.on('sourcedata', (e) => {
    if (selectedLayers.includes(e.sourceId)) {
      if (e.isSourceLoaded) {
        addStatus(`Source "${e.sourceId}" loaded`, 'success');
      }
    }
  });

  // Monitor tile loading
  map.on('data', (e) => {
    if (e.dataType === 'source' && selectedLayers.includes(e.sourceId)) {
      if (e.tile) {
        const tile = e.tile;
        if (tile.state === 'loaded') {
          addStatus(`Tile loaded [${e.sourceId}]: z=${tile.tileID.z}, x=${tile.tileID.x}, y=${tile.tileID.y}`, 'success');
        } else if (tile.state === 'errored') {
          addStatus(`Tile error [${e.sourceId}]: z=${tile.tileID.z}, x=${tile.tileID.x}, y=${tile.tileID.y}`, 'error');
        }
      }
    }
  });

  // Test tile URLs directly for selected layers
  selectedLayers.forEach(layerType => {
    const tileUrl = `${baseUrl}/${layerType}/{z}/{x}/{y}?surveySessionId=${surveySessionId}`;
    const testUrl = tileUrl.replace('{z}', '15').replace('{x}', '1600').replace('{y}', '1300');
    addStatus(`Testing ${layerType} tile URL: ${testUrl}`, 'info');
    
    fetch(testUrl)
      .then(response => {
        if (response.ok) {
          addStatus(`${layerType} tile fetch successful: ${response.status} ${response.statusText}`, 'success');
          return response.arrayBuffer();
        } else {
          addStatus(`${layerType} tile fetch failed: ${response.status} ${response.statusText}`, 'error');
          throw new Error(`HTTP ${response.status}`);
        }
      })
      .then(buffer => {
        addStatus(`${layerType} tile data received: ${buffer.byteLength} bytes`, 'success');
      })
      .catch(error => {
        addStatus(`${layerType} tile fetch error: ${error.message}`, 'error');
        console.error(`${layerType} tile fetch error:`, error);
      });
  });
}

function getLayerColor(layerType) {
  const colors = {
    'fov': '#ff0000',
    'lisa': '#00ff00',
    'breadcrumb': '#0000ff'
  };
  return colors[layerType] || '#888888';
}

function updateMap() {
  if (map) {
    map.remove();
  }
  document.getElementById('status').innerHTML = '';
  initializeMap();
}

// Add event listeners to checkboxes to update map when selection changes
availableLayers.forEach(layer => {
  const checkbox = document.getElementById(`layer-${layer}`);
  if (checkbox) {
    checkbox.addEventListener('change', () => {
      updateMap();
    });
  }
});

// Initialize map on page load
initializeMap();
</script>
</body>
</html>

