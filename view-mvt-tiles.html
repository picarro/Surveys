<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MVT Tiles Viewer</title>
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <link
    href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <style>
    body { 
      margin: 0; 
      font-family: Arial, sans-serif;
    }
    #map { 
      width: 100vw; 
      height: 100vh; 
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 300px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .controls input, .controls select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 12px;
    }
    .controls button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #007cbf;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }
    .controls button:hover {
      background: #005a8f;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 3px;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
    }
    .status-item {
      margin: 3px 0;
      padding: 3px;
    }
    .status-item.error {
      color: #d32f2f;
    }
    .status-item.success {
      color: #388e3c;
    }
    .status-item.info {
      color: #1976d2;
    }
  </style>
</head>
<body>
<div class="controls">
  <label>Survey Session ID:</label>
  <input type="text" id="surveySessionId" value="6321d911-496c-4312-9910-fe3929ad255d" placeholder="Enter survey session ID">
  
  <label>Layer Type:</label>
  <select id="layerType">
    <option value="fov">FOV</option>
  </select>
  
  <label>Base URL:</label>
  <input type="text" id="baseUrl" value="http://localhost:3000/api/mvt" placeholder="Base URL for MVT endpoint">
  
  <button onclick="updateMap()">Update Map</button>
  
  <div class="status" id="status">
    <div class="status-item info">Ready to load map...</div>
  </div>
</div>

<div id="map"></div>

<script>
let map;

function addStatus(message, type = 'info') {
  const statusDiv = document.getElementById('status');
  const item = document.createElement('div');
  item.className = `status-item ${type}`;
  item.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
  statusDiv.insertBefore(item, statusDiv.firstChild);
  
  // Keep only last 20 messages
  while (statusDiv.children.length > 20) {
    statusDiv.removeChild(statusDiv.lastChild);
  }
}

function initializeMap() {
  const surveySessionId = document.getElementById('surveySessionId').value;
  const layerType = document.getElementById('layerType').value;
  const baseUrl = document.getElementById('baseUrl').value;
  
  if (!surveySessionId || surveySessionId.trim() === '') {
    addStatus('Error: Survey Session ID is required', 'error');
    return;
  }
  
  const tileUrl = `${baseUrl}/${layerType}/{z}/{x}/{y}?surveySessionId=${surveySessionId}`;
  addStatus(`Initializing map with tile URL: ${tileUrl}`, 'info');
  
  // Add OpenStreetMap as base layer
  map = new maplibregl.Map({
    container: "map",
    style: {
      version: 8,
      sources: {
        "osm": {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "Â© OpenStreetMap contributors"
        },
        [layerType]: {
          type: "vector",
          tiles: [tileUrl],
          minzoom: 14,
          maxzoom: 18
        }
      },
      layers: [
        {
          id: "osm-layer",
          type: "raster",
          source: "osm",
          minzoom: 0,
          maxzoom: 22
        },
        {
          id: `${layerType}-layer`,
          type: "fill",
          source: layerType,
          "source-layer": `${layerType}_layer`,
          paint: {
            "fill-color": getLayerColor(layerType),
            "fill-opacity": 0.6,
            "fill-outline-color": "#000000"
          },
          minzoom: 14,
          maxzoom: 18
        }
      ]
    },
    center: [88.402284538, 22.574099812],
    zoom: 15
  });

  map.on('error', (e) => {
    console.error('Map error:', e);
    addStatus(`Map error: ${e.error ? e.error.message : JSON.stringify(e)}`, 'error');
  });

  map.on('load', () => {
    addStatus('Map loaded successfully', 'success');
    console.log('Map loaded successfully');
    
    // Check if source has data
    const source = map.getSource(layerType);
    if (source) {
      addStatus(`Source "${layerType}" loaded`, 'success');
    }
  });

  map.on('data', (e) => {
    if (e.dataType === 'source' && e.sourceId === layerType) {
      if (e.isSourceLoaded) {
        addStatus(`Source "${layerType}" data loaded`, 'success');
      }
    }
  });

  map.on('sourcedata', (e) => {
    if (e.sourceId === layerType) {
      if (e.isSourceLoaded) {
        addStatus(`Source "${layerType}" loaded`, 'success');
      }
    }
  });

  // Monitor tile loading
  map.on('data', (e) => {
    if (e.dataType === 'source' && e.sourceId === layerType) {
      if (e.tile) {
        const tile = e.tile;
        if (tile.state === 'loaded') {
          addStatus(`Tile loaded: z=${tile.tileID.z}, x=${tile.tileID.x}, y=${tile.tileID.y}`, 'success');
        } else if (tile.state === 'errored') {
          addStatus(`Tile error: z=${tile.tileID.z}, x=${tile.tileID.x}, y=${tile.tileID.y}`, 'error');
        }
      }
    }
  });

  // Test tile URL directly
  const testUrl = tileUrl.replace('{z}', '15').replace('{x}', '24430').replace('{y}', '14273');
  addStatus(`Testing tile URL: ${testUrl}`, 'info');
  
  fetch(testUrl)
    .then(response => {
      if (response.ok) {
        addStatus(`Tile fetch successful: ${response.status} ${response.statusText}, Content-Type: ${response.headers.get('Content-Type')}`, 'success');
        return response.arrayBuffer();
      } else {
        addStatus(`Tile fetch failed: ${response.status} ${response.statusText}`, 'error');
        throw new Error(`HTTP ${response.status}`);
      }
    })
    .then(buffer => {
      addStatus(`Tile data received: ${buffer.byteLength} bytes`, 'success');
    })
    .catch(error => {
      addStatus(`Tile fetch error: ${error.message}`, 'error');
      console.error('Tile fetch error:', error);
    });
}

function getLayerColor(layerType) {
  const colors = {
    'fov': '#ff0000',
    'lisa': '#00ff00',
    'breadcrumb': '#0000ff'
  };
  return colors[layerType] || '#888888';
}

function updateMap() {
  if (map) {
    map.remove();
  }
  document.getElementById('status').innerHTML = '';
  initializeMap();
}

// Initialize map on page load
initializeMap();
</script>
</body>
</html>

